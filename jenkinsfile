pipeline {
    agent any
    environment {
        KUBECTL = "/usr/local/bin/kubectl"
    }
    stages {
        stage('Start Minikube') {
            steps {
                sh '/usr/local/bin/minikube_custom start'
            }
        }
        stage('Create Pod') {
            steps {
                sh '${KUBECTL} run test-pod --image=musheer121/pytest-runner --restart=Never -- sleep 600'
                sh '${KUBECTL} wait --for=condition=Ready pod/test-pod --timeout=60s'
            }
        }

        stage('Run Pytest') {
            steps {
                sh '${KUBECTL} exec test-pod -- bash -c "cd pyTest && pytest -n auto -v"'
            }
        }
    }
    post {
        always {
            echo 'Cleaning up.....'
            sh '${KUBECTL} delete pod test-pod || true'
        }
    }
}
